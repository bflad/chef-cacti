#
#  Dynamically generated by Chef on <%= node["fqdn"] %>
#  Local modifications will be overwritten by Chef.
#
<VirtualHost *:80>
  ServerName <%= @params[:server_name] %>
  ServerAlias <% @params[:server_aliases].each do |a| %><%= a %> <% end %>
  DocumentRoot <%= @params[:doc_root] %>

  <% if %w(debian ubuntu).include? node['platform'] -%>
  Alias /javascript /usr/share/javascript

  <% end -%>
  CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-access.log combined
  ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-error.log
  LogLevel info

  <% if @params[:ssl_forced] -%>
  RewriteEngine On
  RewriteCond %{HTTPS} off
  RewriteCond $1 !^(/)?server-status
  RewriteRule (.*) https://<%= @params[:server_name] %>/cacti/
  <% end -%>
</VirtualHost>
<% if @params[:ssl_enabled] -%>

<VirtualHost *:443>
  ServerName <%= @params[:server_name] %>
  ServerAlias <% @params[:server_aliases].each do |a| %><%= a %> <% end %>
  DocumentRoot <%= @params[:doc_root] %>

  <% if %w(debian ubuntu).include? node['platform'] -%>
  Alias /javascript /usr/share/javascript

  <% end -%>
  CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-ssl-access.log combined
  ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-ssl-error.log
  LogLevel info

  SSLEngine on
  SSLCertificateFile <%= @params[:ssl_certificate_file] %>
  SSLCertificateKeyFile <%= @params[:ssl_key_file] %>
  <% unless @params[:ssl_chain_file].empty? -%>
  SSLCertificateChainFile <%= @params[:ssl_chain_file] %>
  <% end -%>

  RewriteEngine On
  RewriteCond %{http_host} ^<%= @params[:server_name] %>
  RewriteRule ^/$ https://<%= @params[:server_name] %>/cacti/ [R=301,NC,L]
</VirtualHost>
<% end -%>
